{% extends 'base.html' %}

{% block title %}Home Page{% endblock %}

{% block content %}

<style>
    
    .preview-container.fading {
            opacity: 0;
        }

        .preview-image.visible {
            opacity: 1;
        }

        .comparison-container {
            position: relative;
            width: 100%;
            margin-bottom: 2rem;
            border-radius: 12px;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .comparison-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .comparison-container.visible .image,
        .comparison-container.visible .enhanced-image,
        .comparison-container.visible .slider-handle,
        .comparison-container.visible .comparison-labels {
            opacity: 1;
            transform: translateY(0);
        }
        .comparison-container .slider-handle {
            transform: translate(-50%, -50%) scale(0.8);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.2s; /* Added delay */
        }
        .comparison-container.visible .slider-handle {
            transform: translate(-50%, -50%) scale(1);
        }
        .comparison-container .comparison-labels {
            transform: translateY(-20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.3s; /* Added delay */
        }
        .comparison-container.visible .comparison-labels {
            transform: translateY(0);
        }

        .image, .enhanced-image {
            width: 100%;
            height: auto;
            min-height: 300px;
            max-height: 500px;
            object-fit: contain;
            background-color: #f8f9fa;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        .download-section {
            background: linear-gradient(to right, #f8f9fa, white);
            border-radius: 0 0 12px 12px;
            position: relative;
            opacity: 0.5;
            margin: 20px auto;
            padding: 15px;
            text-align: center;
            width: 100%;
            max-width: 300px;
            z-index: 9999;
        }

        .btn-download {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 500;
            font-size: clamp(14px, 4vw, 16px);
            z-index: 9999;
        }

        .btn-download:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .format-dropdown {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: absolute;
            top: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            min-width: 120px;
            z-index: 1000;
        }

        .format-dropdown.show {
            display: block;
            animation: dropdownFade 0.2s ease;
        }

        .format-option {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: center;
        }

        .format-option:hover {
            background-color: #f8f9fa;
            color: #007bff;
        }


        /* Comparison labels */
        .comparison-labels {
            position: absolute;
            top: 20px;
            width: 100%;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            display: flex;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            justify-content: space-between;
            padding: 0 20px;
        }

        .label {
            padding: 8px 16px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(4px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .label-before {
            transform: translateX(50%);
            opacity: 0.8;
        }

        .label-after {
            transform: translateX(-50%);
            opacity: 0.8;
        }

        .comparison-container:hover .label {
            opacity: 1;
            transform: translateX(0);
        }

        .error-overlay {
            backdrop-filter: blur(8px);
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }

        .error-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 300px;
            margin: 0 1rem;
        }

        .error-content h4 {
            color: #dc3545;
            font-weight: 500;
        }

        .error-content p {
            color: #6c757d;
            margin-bottom: 1rem;
        }
        .error-content .btn-primary {
            background-color: #007bff;
            border: none;
            padding: 0.5rem 2rem;
            transition: all 0.3s ease;
        }
        .error-content .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
        }
        /* Controls and buttons */
        .add-button {
            /* background: linear-gradient(135deg, #007bff, #0056b3); */
            position: fixed;
            /*left: 20px; */
            bottom: 50px;
            width: 56px;
            height: 56px;
            background-color: #6e6e76;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer !important;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto !important;  /* Force les événements de souris */
            user-select: none;  /* Empêche la sélection de texte */
            -webkit-tap-highlight-color: transparent;  /* Pour les appareils tactiles */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 9999;
        }

        .add-button:hover {
            transform: scale(1.1) rotate(90deg);
            background-color: #0056b3;
            transition: all 0.3s ease;
        }

        .twentytwenty-container {
            width: 100%;
            max-width: 800px;
            height: auto;
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            min-height: 200px;
            touch-action: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .twentytwenty-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .twentytwenty-handle {
            transform: none !important;
            border: 3px solid white;
            height: 40px;
            width: 40px;
            margin-left: -20px;
            margin-top: -20px;
            background: white;
            box-shadow: 0 0 12px rgba(0,0,0,0.2);
        }

        .twentytwenty-overlay {
            background: none;
        }

        /* Fix pour le problème de rectangle caché */
        .twentytwenty-before-label,
        .twentytwenty-after-label {
            opacity: 1 !important;
            pointer-events: none;
        }
        .twentytwenty-before-label::before,
        .twentytwenty-after-label::before {
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 12px;
            padding: 8px 12px;
            position: absolute;
            font-size: 12px;
            top: 50%;
        }

        .twentytwenty-before-label::before {
            content: "before" !important;
            right: 10px;
            transform: translate(25%, -50%);
        }

        .twentytwenty-after-label::before {
            content: "after" !important;
            left: 10px;
            transform: translate(75%, -50%);
        }

        /* progress container*/
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .progress-container.active {
            opacity: 1;
        }

        .progress-bar-wrapper {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 4px;
            margin: 20px 0;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.2);
        }
        .progress-bar {
            height: 8px;
            background: linear-gradient(90deg, #007bff, #00ff88);
            border-radius: 20px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shine 1.5s infinite;
        }
        .progress-message {
            color: white;
            font-size: 18px;
            margin-bottom: 15px;
            min-height: 27px;
            text-align: center;
            opacity: 0;
            transform: translateY(10px);
        }
        .progress-message.active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease;
        }
        .progress-percentage {
            color: #00ff88;
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
            background: linear-gradient(90deg, #007bff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Style pour le sidebar de navigation */
/*#nav-sidebar {
    position: fixed;
    right: 0;
    top: max(20px, env(safe-area-inset-top));
    width: 80px;
    height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    background-color: rgba(255, 255, 255, 0.95);
    /* ... reste des propriétés ... */
/*} */

/* Style pour le sidebar d'historique */
/*#history-sidebar {
    /* Propriétés spécifiques pour l'historique */
    /*display: flex;
    flex-direction: column;
    width: 100%;
    height: auto;
    /* ... autres propriétés ... */

/*} */
        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Animations de feedback */
        @keyframes success-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .success-message {
            animation: success-pulse 0.5s ease;
        }

        @media (max-width: 768px) {
            .twentytwenty-container {
                border-radius: 0;
                margin: 10px 0;
            }

            .sidebar {
                width: 60px;
            }
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }


        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }


            .sidebar.open img {
                opacity: 1;
                transform: translateX(0);
            }

            .add-button {
                width: 48px;
                height: 48px;
                left: 16px;
                bottom: 16px;
            }

            .label {
                padding: 6px 12px;
                font-size: 12px;
            }

            .slider-handle {
                width: 32px;
                height: 32px;
            }
            @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 20px;
            }
                @supports not (padding: env(safe-area-inset-top)) {
            .sidebar {
                top: 0;
                height: 100vh;
                padding: 20px 0;
            }
}
}
}
    </style>
</style>

<div class="neltar_fn_page">
				
    <!-- Image Generation Page -->
    <div class="neltar_fn_image_generation_page">
        
        <div class="generation__page">

            <!-- Image Generation history-->
            <div class="generation_history" id="history-container">
                <div class="fn__generation_item">
                    <div class="item_header">
                        <div class="title_holder">
                            <h2 class="prompt_title">Images History</h2>
                        </div>
                    </div>
                    <div class="item_list">
                        <ul class="fn__generation_list" id="history-content">
                            <!-- Les images de l'historique seront chargées ici -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Generation Header -->
            <div class="generation_header">
                <div class="container">
                    <h1 class="text-center mb-4">Améliorer la Qualité d'une Image</h1>
                    <div id="image-container"></div>
                </div>
            
                <div class="progress-container">
                    <div class="progress-message"></div>
                     <div class="progress-percentage">0%</div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            
                
                <button class="add-button" id="add-button">+</button>
                <input type="file" id="file-input" accept="image/png, image/jpeg, image/jpg, image/gif" style="display: none;">

            
                <div class="loading-overlay" id="loading-overlay">
                    <div class="loading-spinner"></div>
                </div>
                
            </div>
            
         
            
        </div>
        
   
        
    </div>
    
</div>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='/dst/css/twentytwenty.css') }}" type="text/css" />
<link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}">
<script>
    // Configuration and initialization
const headers = {
'X-Requested-With': 'XMLHttpRequest',
'Accept': 'application/json'
};


// DOM Elements
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 10 MB in bytes

let currentPage = 1;
let isLoading = false;
let hasMore = true;

document.addEventListener('DOMContentLoaded', function() {
    console.error('DOM Content Loaded');

    const fileInput = document.getElementById('file-input');
    console.error('File Input found:', !!fileInput);

    const addButton = document.getElementById('add-button');
    console.error('Add Button found:', !!addButton);
    addButton.disabled = false;
    addButton.style.pointerEvents = 'auto';

    // Test pour voir si les événements atteignent le bouton
    addButton.addEventListener('mouseover', () => {
        console.log('Hover test');
        addButton.style.backgroundColor = '#0056b3';  // Change de couleur au hover
    });

    //const navSidebar = document.getElementById('nav-sidebar');
    //console.error('Nav Sidebar found:', !!navSidebar);

    //const closeSidebarButton = document.getElementById('close-sidebar');
    const imageContainer = document.getElementById('image-container');
    console.error('Image Container found:', !!imageContainer)
    const loadingOverlay = document.getElementById('loading-overlay');

    const elements = {
        fileInput: document.getElementById('file-input'),
        addButton: document.getElementById('add-button'),
        //navSidebar: document.getElementById('nav-sidebar'),
        //closeSidebarButton: document.getElementById('close-sidebar'),
        imageContainer: document.getElementById('image-container'),
        loadingOverlay: document.getElementById('loading-overlay'),
        historyLoader: document.getElementById('history-sidebar'),
        historyContent: document.getElementById('history-sidebar')
    };

    // 2. Logs de vérification
    console.error('File Input found:', !!elements.fileInput);
    console.error('Add Button found:', !!elements.addButton);
    //console.error('Nav Sidebar found:', !!elements.navSidebar);

    // 3. Configuration initiale
    if (elements.fileInput) {
        elements.fileInput.setAttribute('accept', 'image/png, image/jpeg, image/jpg, image/gif');
    }
    // 4. Event Listeners
    if (elements.addButton) {
        elements.addButton.style.pointerEvents = 'auto';
        elements.addButton.style.cursor = 'pointer';

        elements.addButton.addEventListener('click', function(e) {
            console.error('=== ADD BUTTON CLICKED ===');
            e.preventDefault();
            e.stopPropagation();
            elements.fileInput.click();
        });

        elements.addButton.addEventListener('mouseover', () => {
            console.log('Button hover detected');
        });
        // Ajout d'un gestionnaire sur le document pour voir où les clics arrivent
    document.addEventListener('click', (e) => {
        console.log('Click target:', e.target);
        console.log('Click coordinates:', e.clientX, e.clientY);
    }, true);  // true pour la phase de capture
    }
    if (elements.fileInput) {
        elements.fileInput.addEventListener('change', async function(event) {
            console.error('L:790')
            if (event.target.files && event.target.files[0]) {
                await handleFileUpload(event.target.files[0], elements);
            } else {
                console.error('FAIL File Upload')
            }
        });
    }

    //if (elements.closeSidebarButton) {
      //  elements.closeSidebarButton.addEventListener('click', function() {
      //      console.error('=== CLOSE BUTTON CLICKED ===');
      //      elements.navSidebar.classList.remove('open');
      //  });
    //}


    if (!fileInput || !addButton) {
        console.error('Required elements not found');
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (token) {
        // Modifier TOUS les liens de navigation
        document.querySelectorAll('a').forEach(link => {
            // Ne pas modifier les liens externes
            if (link.href.startsWith(window.location.origin)) {
                const url = new URL(link.href);
                // Préserver les autres paramètres d'URL existants
                url.searchParams.set('token', token);
                link.href = url.toString();
            }
        });

        // Modifier tous les formulaires pour inclure le token
        document.querySelectorAll('form').forEach(form => {
            if (!form.querySelector('input[name="token"]')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'token';
                input.value = token;
                form.appendChild(input);
            }
        });
        const addButtonStyle = window.getComputedStyle(addButton);
        console.error('Add Button Styles:', {
            backgroundColor: addButtonStyle.backgroundColor,
            display: addButtonStyle.display,
            position: addButtonStyle.position,
            zIndex: addButtonStyle.zIndex,
            visibility: addButtonStyle.visibility,
            opacity: addButtonStyle.opacity
        });
    }
    // 4. Configuration des conteneurs
    const containers = document.querySelectorAll('.comparison-container');
    containers.forEach(container => {
        setupImageComparison(container);
        setupEntranceAnimation(container);
    });


    // Gestionnaire d'événement pour le changement de fichier
    //fileInput.addEventListener('change', async function (event) {
        //console.error('File input changed:', event.target.files)
        //if (event.target.files && event.target.files[0]) {
            //console.log('File selected:', {
                //name: event.target.files[0].name,
                //type: event.target.files[0].type,
                //size: event.target.files[0].size
            //});
            //await handleFileUpload(event.target.files[0]);
       // }
   // });


    // 5. Gestionnaire pour fermer avec Escape
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            //navSidebar.classList.remove('open');
            document.querySelectorAll('.format-dropdown').forEach(dropdown =>
                dropdown.classList.remove('show')
            );
        }
    });

    // Image Upload and Processing
    async function handleFileUpload(file) {
        if (!file) {
            console.error('No file selected')
            return;
        }
        const fileDetails = {
            name: file.name,
            type: file.type,
            size: file.size,
            sizeInMB: (file.size / (1024 * 1024)).toFixed(2)
        };
        console.error('File Dtails:', fileDetails)

        // Check file size before uploading
        if (file.size > MAX_FILE_SIZE) {
            const infoText = document.createElement('p');
            infoText.className = 'text-muted small file-size-info';
            infoText.textContent = `Le fichier fait ${(file.size / (1024 * 1024)).toFixed(2)} MB. La taille maximum autorisée est de 20 MB`;

            const oldInfo = document.querySelector('.file-size-info');
            if (oldInfo) {
                oldInfo.remove();
            }
            document.querySelector('.container').insertBefore(infoText, document.getElementById('image-container'));

            console.log('File size exceeds client-side limit:', {
                fileSize: file.size,
                maxSize: MAX_FILE_SIZE,
                fileSizeMB: (file.size / (1024 * 1024)).toFixed(2),
                maxSizeMB: (MAX_FILE_SIZE / (1024 * 1024)).toFixed(2)
            });

            showErrorOverlay(
                'Fichier trop volumineux',
                'Le fichier ne doit pas dépasser 20 MB'
            );
            return;
        }
        loadingOverlay.classList.add('active');

        const infoText = document.querySelector('.file-size-info');
        if (infoText) {
            infoText.remove();
        }

        console.log('Files details:', {
            name: file.name,
            type: file.type,
            size: `${(file.size / (1024 * 1024)).toFixed(2)} MB`
        });
        console.error('L:929')
        // Validate file format
        const acceptedFormats = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
        console.error('Checking file format:', file.type);
        if (!acceptedFormats.includes(file.type)) {
            console.error('Invalid file format');
            showErrorOverlay(
                'Format non supporté',
                'Veuillez importer un fichier en PNG, JPEG, JPG, ou GIF.'
            );
            return;
        }

        // Show loading state
        loadingOverlay.classList.add('active');

        try {
            await progressBar.simulateProgress();

            // Get token and prepare form data
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            console.log('Token present:', !!token)
            const formData = new FormData();
            formData.append('file', file);
            console.log('FormData created with file');

            console.log('Sending request with:', {
                fileSize: file.size,
                fileName: file.name,
                token: token ? 'Present' : 'Missing'
            });


            // Upload and get enhanced image
            console.error('Starting fetch request...')
            const response = await fetch(`/upload-enhance?token=${encodeURIComponent(token)}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
            });
            console.error('fetch response received:', response.status);
            console.error('Response headers:', Object.fromEntries([...response.headers]));


            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error:', {
                    status: response.status,
                    statusText: response.statusText,
                    errorText: errorText
                });

                let errorMessage = 'Une erreur est survenue lors du traitement de l\'image.';

                if (response.status === 413) {
                    errorMessage = 'Le fichier est trop volumineux pour le serveur. Limite: 20 MB';
                    console.error('file too large error:', {
                        fileSize: file.size,
                        fileSizeMB: (file.size / (1024 * 1024)).toFixed(2)
                    });
                }

                showErrorOverlay('Erreur', errorMessage);
                loadingOverlay.classList.remove('active');
                return;
            }
            const result = await handleApiResponse(response);
            console.error('Response parsed successfully:', result);
            if (!result) return;

            // Create image objects and update UI
            const imageId = Date.now();
            const newImage = {
                id: imageId,
                original: URL.createObjectURL(file),
                enhanced: result.enhanced_url,
                sliderValue: 50
            };
            console.error('new Image', newImage)
            enhancedImages.unshift(newImage);
            //addImageToSidebar(newImage);
            createImageComparison(newImage);
            //selectImage(imageId);
            //sidebar.classList.add('open');

        } catch (error) {
            console.error('Error:', error);
            showErrorOverlay(
                'Erreur',
                'Une erreur est survenue lors du traitement de l\'image.'
            );
        } finally {
            progressBar.hide();
            fileInput.value = '';
        }
    }

    // Create and load images first
        const originalImg = new Image();
        const enhancedImg = new Image();

    // UI Component Creation
    function createImageComparison(image) {
        console.error('Image data received:', image)

        loadingOverlay.classList.add('active');

        const container = document.createElement('div');
        container.id = `comparison-${image.id}`;
        container.className = 'twentytwenty-container';

        // Create and load images first
        //const originalImg = new Image();
        //const enhancedImg = new Image();

        // Promise to ensure both images are loaded
        const loadImages = new Promise((resolve) => {
            let loadedImages = 0;

            function imageLoaded() {
                loadedImages++;
                if (loadedImages === 2) {
                    setTimeout(resolve, 500);
                }
                console.error('imageLoaded:', loadedImages)
            }

            originalImg.onload = imageLoaded;
            enhancedImg.onload = imageLoaded;
            originalImg.onerror = () => {
                console.error('Error loading original image', originalImg.src);
                loadingOverlay.classList.remove('active');
            }
            enhancedImg.onerror = () => {
                console.error('Error loading enhanced image', enhancedImg.src);
                loadingOverlay.classList.remove('active');
            }


            originalImg.src = image.original;
            originalImg.alt = "Original";
            enhancedImg.src = image.enhanced;
            enhancedImg.alt = "Enhanced";

        });

        container.appendChild(originalImg);
        container.appendChild(enhancedImg);

        imageContainer.insertBefore(container, imageContainer.firstChild);

        loadImages.then(() => {
            console.error('VO');
            $(container).twentytwenty({
                default_offset_pct: 0.5,
                before_label: 'before',
                after_label: 'after',
                no_overlay: false,
                move_slider_on_hover: true,
                move_with_handle_only: false,
                click_to_move: true
            });

            // Force à recalculer les dimensions
            window.dispatchEvent(new Event('resize'));

            // Attendez que TwentyTwenty soit complètement initialisé
            setTimeout(() => {
                loadingOverlay.classList.remove('active');
                container.classList.add('visible');
            }, 1000);
        });

        console.error('After')
        container.after(downloadSection);

        loadImages.then(() => {
            setTimeout(() => {
                $(container).twentytwenty({
                    default_offset_pct: 0.5,
                    before_label: 'before',
                    after_label: 'after',
                    no_overlay: false,
                    move_slider_on_hover: true,
                    move_with_handle_only: false,
                    click_to_move: true
                });
                window.dispatchEvent(new Event('resize'));
                loadingOverlay.classList.remove('active');
            }, 100);
        });

    }


        // Fonction pour charger l'historique
    async function loadHistory(page = 1, append = false) {
        const historyLoader = document.getElementById('historyloader');
        const historyContent = document.getElementById('history-content');

        if (!historyContent) {
            console.error('History content not found.')
            return;
        }
        console.log(`Fetching history for page ${page}...`);
        if (isLoading || (!append && !hasMore)) return;


        isLoading = true;
        if (historyLoader) historyLoader.classList.remove('d-none');

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            const response = await fetch(`/api/chat/history/enhanced?page=${page}&token=${encodeURIComponent(token)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = LOGIN_URL;
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Fetched data:', data);

            if (!append) {
                historyContent.innerHTML = '';
            }

            const items = data.data?.items || [];

            if (items.length > 0) {
                items.forEach((item, index) => {
                    const delay = index * 100;
                    const historyItem = createHistoryItem({
                        original_url: `/image/${item.original_key}`,
                        enhanced_url: `/image/${item.enhanced_key}`,
                        timestamp: item.timestamp
                    }, delay);
                    historyContent.appendChild(historyItem);
                });

                hasMore = data.data?.pagination?.has_more || false;
                currentPage = page;
            } else {
                if (!append) {
                    historyContent.innerHTML = '<p class="text-center">Aucun historique disponible</p>';
                }
                hasMore = false;
            }

        } catch (error) {
            console.error('Error loading history:', error);
            if (historyContent) {
                historyContent.innerHTML += '<p class="text-center text-danger">Erreur lors du chargement de l\'historique</p>';
            }
        } finally {
            isLoading = false;
            if (historyLoader) historyLoader.classList.add('d-none');
        }
    }

    // Fonction pour créer un élément d'historique
    function createHistoryItem(item, delay) {
        const listItem = document.createElement('li');
        listItem.className = 'fn__gl_item';

        listItem.innerHTML = `
           <div class="fn__gl__item">
               <div class="comparison-container">
                   <img src="${item.original_url}" alt="Original image" class="image original-image">
                   <img src="${item.enhanced_url}" alt="Enhanced Image" class="image enhanced-image">
                       <div class="comparison-labels">
                        <div class="label label-before">Original</div>
                        <div class="label label-after">Amélioré</div>
                   </div>
                   <div class="all_options">
                       <div class="fn__icon_options medium_size">
                           <div class="dropdown">
                               <button class="fn__icon_button dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                   <img src="/static/assets/svg/download.svg" alt="" class="fn__svg">
                                </button>                                <ul class="dropdown-menu dropdown-menu-dark">
                                   <li class="dropdown-item" data-format="png" data-url="${item.url}">PNG</li>
                                   <li class="dropdown-item" data-format="jpg" data-url="${item.url}">JPG</li>
                                   <li class="dropdown-item" data-format="jpeg" data-url="${item.url}">JPEG</li>
                                   <li class="dropdown-item" data-format="gif" data-url="${item.url}">GIF</li>
                               </ul>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       `;

        // Initialiser le slider TwentyTwenty pour chaque élément
        const comparisonContainer = listItem.querySelector('.comparison-container');
        $(comparisonContainer).twentytwenty({
            default_offset_pct: 0.5,
            before_label: 'Original',
            after_label: 'Amélioré',
            no_overlay: false,
            move_slider_on_hover: true,
            move_with_handle_only: false,
            click_to_move: true
        });

        // Gestion des événements
        const downloadButtons = listItem.querySelectorAll('.dropdown-item');
        downloadButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const format = button.getAttribute('data-format');
                const imageUrl = button.getAttribute('data-url');
                if (format && imageUrl) {
                    downloadImage(imageUrl, format);
                }
            });
        });

        listItem.style.animationDelay = `${delay}ms`;
        return listItem;
    }

    // 1. Fonction de configuration de la comparaison d'images
    function setupImageComparison(container) {
        $(container).twentytwenty({
            default_offset_pct: 0.5,
            before_label: 'Original',
            after_label: 'Amélioré',
            no_overlay: false,
            move_slider_on_hover: true,
            move_with_handle_only: false,
            click_to_move: true
        });
    }
    // Ajoutons cette fonction dans votre DOMContentLoaded
    function checkForOverlays() {
        const button = document.getElementById('add-button');
        const rect = button.getBoundingClientRect();
        const elements = document.elementsFromPoint(
            rect.left + rect.width/2,
             rect.top + rect.height/2
        );
        console.log('Elements au-dessus du bouton:', elements);
    }


    // Appelons-la pour voir ce qui pourrait bloquer le bouton
    checkForOverlays();

    // Configuration du file input
    fileInput.setAttribute('accept', 'image/png, image/jpeg, image/jpg, image/gif');
    console.error('Required elements not found:', {
        fileInput: !!fileInput,
        addButton: !!addButton,
        //navSidebar: !!navSidebar,
        //closeSidebarButton: !!closeSidebarButton
    });


    addButton.style.pointerEvents = 'auto';
    addButton.style.cursor = 'pointer';

    // Test du hover
    addButton.addEventListener('mouseover', () => {
        console.log('Button hover detected');
    });


    loadHistory(1, false);
    console.error('History load succesfully ')
});


class ProgressBar {
constructor() {
   this.container = document.querySelector('.progress-container');
    this.bar = document.querySelector('.progress-bar');
    this.message = document.querySelector('.progress-message');
    this.percentage = document.querySelector('.progress-percentage');
    this.messages = [
        "Initialisation...",
        "Analyse de l'image...",
        "Application des améliorations...",
        "Optimisation des détails...",
        "Finalisation..."
    ];
}
show() {
    this.container.classList.add('active');
}

hide() {
    this.container.classList.remove('active');
}

updateProgress(progress) {
    this.bar.style.width = `${progress}%`;
    this.percentage.textContent = `${Math.round(progress)}%`;

    // Mise à jour du message en fonction de la progression
    const messageIndex = Math.floor((progress / 100) * (this.messages.length - 1));
    this.updateMessage(this.messages[messageIndex]);
}
        updateMessage(text) {
    this.message.classList.remove('active');
    setTimeout(() => {
        this.message.textContent = text;
        this.message.classList.add('active');
    }, 300);
}
async simulateProgress() {
    this.show();
    let progress = 0;
    const increment = () => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        this.updateProgress(progress);

        if (progress < 100) {
            setTimeout(increment, 500 + Math.random() * 500);
        } else {
            setTimeout(() => this.hide(), 1000);
        }
    };
    increment();
}
}
const progressBar = new ProgressBar();

// State
let enhancedImages = [];
let selectedImageId = null;

// Image Preview Handling
async function createImagePreview(file) {
return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => resolve({
            width: img.width,
            height: img.height,
            src: e.target.result
        });
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
});
}
function showErrorOverlay(tittle, message, isAuthError = false) {
const loadingOverlay = document.getElementById('loading-overlay');
loadingOverlay.innerHTML = `
    <div class="error-message text-center">
        <h4 class="mb-3">${title}</h4>
        <p class="mb-4">${message}</p>
        ${isAuthError ? `
            <a href="https://aitheway.com/login/" class="btn btn-primary">
                Se connecter
            </a>
        ` : ''}
    </div>
`;

loadingOverlay.classList.add('active');

if (!isAuthError)
    setTimeout(() => {
        loadingOverlay.classList.remove('active');
    }, 5000);
}


function setupEntranceAnimation(container) {
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            requestAnimationFrame(() => {
                container.classList.add('visible');
                const elements = container.querySelectorAll('.image, .enhanced-image, .slider-handle, .comparison-labels');
                elements.forEach((el, index) => {
                    setTimeout(() => {
                        el.classList.add('visible');
                    }, index * 100);
                });
            });
            observer.disconnect();
        }
    });
}, {
    threshold: 0.2, // Trigger when 20% of the container is visible
    root: null,     // Use viewport as root
    rootMargin: '0px' // No margin
});
observer.observe(container);
}

async function handleApiResponse(response) {
    console.error('Full response:', response);
    console.error('Response headers:', Object.fromEntries(response.headers));
    console.error('Response status:', response.status);

if (!response.ok) {
    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
    console.error('API Error:', errorData)
    showErrorOverlay('Erreur', errorData.message || 'Une erreur est survenue');
    return null;
}
const result = await response.json();
console.error('Passed result:', result)
return result;
}

async function downloadImage(url, format) {
    console.error('Download Start')
    try {
        const response = await fetch(url, {headers});
        if (!response.ok) {
            throw new Error('Download failed');
        }
        const blob = await response.blob();
        const downloadUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `image-amelioree.${format}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(downloadUrl);
    } catch (error) {
        console.error('Download error:', error);
        showErrorOverlay(
            'Erreur de téléchargement',
            'Impossible de télécharger l\'image. Veuillez réessayer.'
        );
    }


//function selectImage(imageId) {
//selectedImageId = imageId;

//document.querySelectorAll('.sidebar img').forEach(img => {
    //  img.classList.toggle('selected', img.dataset.id == imageId);
//});

//const selectedElement = document.getElementById(`comparison-${imageId}`);
//if (selectedElement) {
    //selectedElement.scrollIntoView({
    //   behavior: 'smooth',
    // block: 'center', //changé de start à slider
    // inline: 'nearest'
    //});
//}
}


function adjustDropdownPosition(dropdown) {
    const rect = dropdown.getBoundingClientRect();
    const viewportHeight = window.innerHeight;

    if (rect.bottom > viewportHeight) {
        dropdown.style.top = 'auto';
        dropdown.style.bottom = '100%';
    } else {
        dropdown.style.top = '100%';
        dropdown.style.bottom = 'auto';
    }
}


    //document.addEventListener('click', function(e) {
    //if (!e.target.closest('.sidebar') && !e.target.closest('.add-button')) {
    //    const sidebar = document.querySelector('.sidebar');
    //    if (sidebar.classList.contains('open')) {
    //        sidebar.classList.remove('open');
    //    }
    //}
//});

    const downloadSection = document.createElement('div');
        downloadSection.className = 'download-section';
        downloadSection.innerHTML = `
        <button class="btn-download">Télécharger l'image</button>
        <div class="format-dropdown">
            ${['PNG', 'JPG', 'JPEG', 'GIF'].map(format =>
            `<div class="format-option" data-format="${format.toLowerCase()}">${format}</div>`
        ).join('')}
        </div>
    `;

        // Gérer le téléchargement
        const downloadButton = downloadSection.querySelector('.btn-download');
        const formatDropdown = downloadSection.querySelector('.format-dropdown');

        downloadButton.addEventListener('click', (e) => {
        e.stopPropagation();
        console.error('Click');
        document.querySelectorAll('.format-dropdown').forEach(dropdown => {
            if (dropdown !== formatDropdown) {
                dropdown.classList.remove('show');
            }
        });
        formatDropdown.classList.toggle('show');
        adjustDropdownPosition(formatDropdown);
    });

    formatDropdown.addEventListener('click', (e) => {
        console.error('click e for show format')
        if (e.target.classList.contains('format-option')) {
            console.error('Calling Download')
            downloadImage(image.enhanced, e.target.dataset.format);
            console.error('Back from dowmload')
            formatDropdown.classList.remove('show');
        }
    });

    // Fermer le menu quand on clique ailleurs
    document.addEventListener('click', (e) => {
        console.error('Close folder input')
        if (!e.target.closest('.download-section')) {
            formatDropdown.classList.remove('show');
        }
    });

document.addEventListener('click', (e) => {
    console.error('click e')
if (!e.target.closest('.download-section')) {
    document.querySelectorAll('.format-dropdown').forEach(dropdown =>
        dropdown.classList.remove('show')
    );
}
});

document.addEventListener('keydown', (e) => {
    console.error( e.key)
if (e.key === 'Escape') {
    //sidebar.classList.remove('open');
    document.querySelectorAll('.format-dropdown').forEach(dropdown =>
        dropdown.classList.remove('show')
    );
}
});

</script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
{% if show_error %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        window.showErrorOverlay(
            'Authentication Required',
            'Please log in to continue',
            true
        );
    });
</script>
{% endif %}



{% endblock %}
